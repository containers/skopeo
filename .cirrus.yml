---

# Main collection of env. vars to set for all tasks and scripts.
env:
    ####
    #### Global variables used for all tasks
    ####
    # Name of the ultimate destination branch for this CI run, PR or post-merge.
    DEST_BRANCH: "main"
    # Overrides default location (/tmp/cirrus) for repo clone
    GOPATH: &gopath "/var/tmp/go"
    GOBIN: "${GOPATH}/bin"
    GOCACHE: "${GOPATH}/cache"
    GOSRC: &gosrc "/var/tmp/go/src/github.com/containers/skopeo"
    # Required for consistency with containers/image CI
    SKOPEO_PATH: *gosrc
    CIRRUS_WORKING_DIR: *gosrc
    # The default is 'sh' if unspecified
    CIRRUS_SHELL: "/bin/bash"
    # Save a little typing (path relative to $CIRRUS_WORKING_DIR)
    SCRIPT_BASE: "./contrib/cirrus"

    # Google-cloud VM Images
    IMAGE_SUFFIX: "c20241010t105554z-f40f39d13"
    FEDORA_CACHE_IMAGE_NAME: "fedora-${IMAGE_SUFFIX}"

    # Container FQIN's
    FEDORA_CONTAINER_FQIN: "quay.io/libpod/fedora_podman:${IMAGE_SUFFIX}"

    # Built along with the standard PR-based workflow in c/automation_images
    SKOPEO_CIDEV_CONTAINER_FQIN: "quay.io/libpod/skopeo_cidev:${IMAGE_SUFFIX}"


# Default timeout for each task
timeout_in: 45m


gcp_credentials: ENCRYPTED[52d9e807b531b37ab14e958cb5a72499460663f04c8d73e22ad608c027a31118420f1c80f0be0882fbdf96f49d8f9ac0]


# TRY THIS
ostree-rs-ext_task:
    alias: proxy_ostree_ext
    # WARNING: This task potentially performs a container image
    # build (on change) with runtime package installs.  Therefore,
    # its behavior can be unpredictable and potentially flake-prone.
    # In case of emergency, uncomment the next statement to bypass.
    #
    # skip: $CI == "true"
    #
    # Ref: https://cirrus-ci.org/guide/docker-builder-vm/#dockerfile-as-a-ci-environment
    container:
        # The runtime image will be rebuilt on change
        dockerfile: contrib/cirrus/ostree_ext.dockerfile
        docker_arguments:  # required build-args
            BASE_FQIN: quay.io/coreos-assembler/fcos-buildroot:testing-devel
            CIRRUS_IMAGE_VERSION: 2testingOnlyShouldNotConflict
    env:
        EXT_REPO_NAME: ostree-rs-ext
        EXT_REPO_HOME: $CIRRUS_WORKING_DIR/../$EXT_REPO_NAME
        EXT_REPO: https://github.com/ostreedev/${EXT_REPO_NAME}.git
    skopeo_build_script:
        - dnf builddep -y skopeo
        - make
        - make install
    proxy_ostree_ext_build_script:
        - git clone --depth 1 $EXT_REPO $EXT_REPO_HOME
        - cd $EXT_REPO_HOME
        - cargo test --no-run
    proxy_ostree_ext_test_script:
        - cd $EXT_REPO_HOME
        - cargo test -- --nocapture --quiet


# Status aggregator for all tests.  This task simply ensures a defined
# set of tasks all passed, and allows confirming that based on the status
# of this task.
success_task:
    name: "Total Success"
    alias: success
    # N/B: ALL tasks must be listed here, minus their '_task' suffix.
    depends_on:
        - proxy_ostree_ext
    container:
        cpu: 2
        memory: 2
        image: quay.io/libpod/imgts:latest
    env:
        CTR_FQIN: ${FEDORA_CONTAINER_FQIN}
        TEST_ENVIRON: container
    clone_script: mkdir -p "$CIRRUS_WORKING_DIR"
    script: /bin/false
